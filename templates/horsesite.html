{% extends "layout.html" %}
{% block title %}Horse Racing Data Processor{% endblock %}

{% block content %}

<style>
    body {
        background: #fff7d1;
    }
    #results-box {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        background: #fff;
        border: 2px solid #ccc;
        margin-top: 20px;
        border-radius: 5px;
    }
    .result-entry {
        padding: 10px;
        margin-bottom: 15px;
        border-bottom: 1px solid #cfcfcf;
    }
    #buttons {
        margin-top: 10px;
    }
    button.extract {
        background: #4b9fff;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }
</style>

<h1>üêé Horse Racing Data Processor</h1>

<div class="note">
    <p><strong>Tip:</strong> Edit <code>models.json</code> to add or change LLM options.</p>
</div>

<form method="post" id="raceForm">

    <label for="race_date">Race Date:</label>
    <input type="date" id="race_date" name="race_date" value="{{ race_date }}">

    <label for="race_number">Race Number:</label>
    <select id="race_number" name="race_number">
        <option value=""></option>
        {% for n in range(1, 16) %}
        <option value="{{ n }}" {% if race_number == n|string %}selected{% endif %}>
            {{ n }}
        </option>
        {% endfor %}
    </select>

    <label for="race_info">Race Info:</label>
    <textarea id="race_info" name="race_info" rows="8">{{ race_info }}</textarea>

    <label for="summary_data">Summary Data:</label>
    <textarea id="summary_data" name="summary_data" rows="10">{{ summary_data }}</textarea>

    <label for="pace_data">Pace Data:</label>
    <textarea id="pace_data" name="pace_data" rows="10">{{ pace_data }}</textarea>

    <label for="user_insights">User Insights:</label>
    <textarea id="user_insights" name="user_insights" rows="8">{{ user_insights }}</textarea>

    <label for="model_select">Select Model:</label>
    <select id="model_select" name="model" required>
        {% for display_name, model_id in models %}
        <option value="{{ model_id }}" {% if selected_model == model_id %}selected{% endif %}>
            {{ display_name }}
        </option>
        {% endfor %}
    </select>

    <div id="buttons">
        <button type="button" class="extract" onclick="runExtract()">Extract</button>
        <button type="submit">Send to LLM</button>
        <button type="button" class="clear" onclick="clearForm()">Clear All</button>
    </div>

</form>

<div id="results-box">
    {% if result_html %}
    <div class="result-entry">
        {{ result_html|safe }}
    </div>
    {% endif %}
</div>

{% if error %}
<div id="error-section">
    <h2>‚ö†Ô∏è Error:</h2>
    <pre style="background: #f8d7da; color: #721c24;">{{ error }}</pre>
</div>
{% endif %}

<script>
function clearForm() {
    document.getElementById('race_info').value = '';
    document.getElementById('summary_data').value = '';
    document.getElementById('pace_data').value = '';
    document.getElementById('user_insights').value = '';
    document.getElementById('race_number').selectedIndex = 0;
}

function runExtract() {
    const formData = new FormData();
    formData.append("summary_data", document.getElementById("summary_data").value);
    formData.append("race_info", document.getElementById("race_info").value);

    fetch("/horsesite/extract", {
        method: "POST",
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById("race_info").value = data.race_info;
        document.getElementById("summary_data").value = data.summary_data;
        alert(data.message);
    });
}

let box = document.getElementById("results-box");
if (box) box.scrollTop = box.scrollHeight;
</script>

{% endblock %}

