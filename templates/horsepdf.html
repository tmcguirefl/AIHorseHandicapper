{% extends "layout.html" %}

{% block title %}Horse Racing PDF Tool{% endblock %}

{% block content %}
<style>
  /* Override and extend layout.html styles */
  body {
    max-width: 900px;
  }

  .button-group {
    margin-top: 12px;
  }

  .button-group button {
    display: block;
    width: 160px;
    margin-bottom: 10px;
  }

  section {
    margin-bottom: 40px;
    padding: 20px;
    border: 1px solid #ccc;
    border-radius: 10px;
    background: white;
  }

  input[type="file"],
  select,
  textarea {
    width: 100%;
    max-width: 500px;
    box-sizing: border-box;
    padding: 6px 8px;
    font-size: 0.95rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  textarea {
    resize: vertical;
    font-family: monospace;
  }

  .btn {
    margin-right: 10px;
    display: inline-block;
    padding: 8px 16px;
    font-size: 1rem;
    font-weight: bold;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-align: center;
    background-color: #007bff;
    color: white;
  }

  .btn:hover {
    background-color: #0056b3;
  }

  select[multiple] {
    min-height: 150px;
  }
</style>

<h1>Horse Racing Past Performance Tool</h1>

<!-- SECTION 1: Upload PDF -->
<section>
  <h2>1. Upload and Split a Past Performance PDF</h2>
  <form action="{{ url_for('split_bp.upload') }}" method="post" enctype="multipart/form-data">
    <label for="file">Upload PDF:</label>
    <input type="file" name="file" accept=".pdf" required />
    <div class="button-group">
      <button class="btn" type="submit">Split PDF</button>
    </div>
  </form>
</section>

<!-- SECTION 2: Analyze -->
<section>
  <h2>2. Analyze Races (Single or Pick 3)</h2>
  <form action="{{ url_for('split_bp.process') }}" method="post" id="llm-form">
    <label for="directory-select">Choose a Directory:</label>
    <select name="directory" id="directory-select" required>
      <option value="">-- Select Directory --</option>
      {% for dir in directories %}
        <option value="{{ dir }}">{{ dir }}</option>
      {% endfor %}
    </select>

    <label for="file-select">Select Up to 3 Race Files (Pick 3):</label>
    <select name="race_files" id="file-select" multiple size="6" required>
      <!-- Options filtered via JavaScript below -->
      {% for dir, file_list in files.items() %}
        {% for f in file_list %}
          <option data-dir="{{ dir }}" value="{{ f }}">{{ f }}</option>
        {% endfor %}
      {% endfor %}
    </select>

    <label for="model-select">Select LLM Model:</label>
    <select name="model" id="model-select" required>
      {% for m in models %}
        <option value="{{ m }}">{{ m }}</option>
      {% endfor %}
    </select>

    <label for="instructions">Further Instructions (optional):</label>
    <textarea name="instructions" id="instructions" rows="5"
      placeholder="Add any special evaluation or instructions here"></textarea>

    <div class="button-group">
      <button class="btn" type="submit">Send to LLM</button>
      <button class="btn" type="button" onclick="resetForm()">Clear</button>
    </div>
  </form>
</section>

<script>
  const dirSelect = document.getElementById("directory-select");
  const fileSelect = document.getElementById("file-select");
  const allFileOptions = Array.from(fileSelect.options).filter(opt => opt.value !== "");

  dirSelect.addEventListener("change", function () {
    const selectedDir = this.value;

    fileSelect.innerHTML = ""; // Clear all options
    allFileOptions.forEach(opt => {
      if (opt.dataset.dir === selectedDir) {
        fileSelect.appendChild(opt.cloneNode(true));
      }
    });
  });

  fileSelect.addEventListener("change", function () {
    const selectedOptions = Array.from(this.selectedOptions);
    if (selectedOptions.length > 3) {
      alert("You can select up to 3 race files.");
      selectedOptions.slice(3).forEach(opt => opt.selected = false);
    }
  });

  function resetForm() {
    document.getElementById("llm-form").reset();
    fileSelect.innerHTML = "";
  }
</script>

{% endblock %}

